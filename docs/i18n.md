# Internationalization (i18n)

The `pup i18n` command can be used to fetch language files from a GlotPress instance for your project. To enable this
command, you must configure the `i18n` section of your `.puprc` file.

## The bare minimum

```json
{
    "i18n": {
        "slug": "the-slug-used-in-glotpress",
        "textdomain": "my-textdomain",
        "url": "https://translate.wordpress.org/api/projects/wp-plugins/{slug}/stable"
    }
}
```

By default, the config settings for `i18n` inherit defaults from the `i18n_defaults` values in the
[`.puprc-defaults`](/.puprc-defaults) found within `pup`.

## Fetching from multiple sources

If you wish to specify multiple `i18n` configs, being sure to override the `path` value so that the second config
will download language files to an alternate location:

```json
{
    "i18n": [
        {
            "slug": "the-slug-used-in-glotpress",
            "textdomain": "my-textdomain",
            "url": "https://translate.wordpress.org/api/projects/wp-plugins/{slug}/stable"
        },
        {
            "path": "some-other-path/lang",
            "slug": "the-slug-used-in-glotpress",
            "textdomain": "my-textdomain",
            "url": "https://translate.wordpress.org/api/projects/wp-plugins/{slug}/stable"
        }
    ]
}
```

## Command-line options

You can adjust the retry and rate-limit handling behavior when running `pup i18n`:

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `--retries` | `int` | `3` | Number of retries per translation file on failure (minimum 1, maximum 10). Use this to control how aggressive retries should be. |
| `--delay` | `int` | `2` | Base delay in seconds between retries and for HTTP 429 rate-limit backoff (minimum 1). Increase this if you're hitting rate limits frequently. |
| `--batch-size` | `int` | `3` | Batch size for grouping downloads. Used for progress visibility and logging (minimum 1). This does not affect concurrency; downloads are sequential. |
| `--root` | `string` | — | Optional. Run the command from a different directory. |

### Rate-limit handling

When WordPress.org returns HTTP 429 (Too Many Requests), the `pup i18n` command handles it intelligently:

**Backoff strategy:**
- Uses exponential backoff with multipliers `[16, 31, 91, 151]` applied to the base `--delay`
- 1st 429: `delay × 16` (e.g., 2s × 16 = 32s)
- 2nd 429: `delay × 31` (e.g., 2s × 31 = 62s)
- 3rd 429: `delay × 91` (e.g., 2s × 91 = 182s)
- 4th 429: `delay × 151` (e.g., 2s × 151 = 302s)
- Additional 429s: Use the same multiplier as the 4th (capped at highest in the schedule)

**Server hints:**
- If the response includes a `Retry-After` header (numeric seconds), the command respects it BUT caps it at the computed backoff wait time
- Ensures we never wait longer than our backoff schedule allows
- If `Retry-After` is an HTTP-date format, it is ignored and the backoff schedule is used instead

**Retry consumption:**
- Each HTTP 429 consumes one retry attempt from `--retries`
- Non-429 failures (4xx/5xx errors, invalid responses) also consume retries and use the base `--delay`
- Once `--retries` are exhausted, the download fails for that translation file

**Example waits:**
- With `--delay=2 --retries=3`: Up to 3 attempts (0, 1, 2); if all are 429s: 32s + 62s + 182s = ~4.6 minutes total
- With `--delay=2 --retries=10`: Up to 10 attempts; if first 4 are 429s: 32s + 62s + 182s + 302s = ~9.6 minutes, then 5 more retries with base 2s delay

**Example commands:**
```bash
# Conservative: fewer retries, longer delay between attempts
pup i18n --retries=2 --delay=3

# Aggressive: more retries, shorter delay (use with caution on rate-limited APIs)
pup i18n --retries=5 --delay=1
```

## Configuration file options

| Config option               | Type | Description                                                                                                                                       |
|-----------------------------|---|---------------------------------------------------------------------------------------------------------------------------------------------------|
| `file_format`               | `string` | The format of the file name for each language file that is downloaded. See [`.puprc-defaults`](/.puprc-defaults) for the default value.           |
| `filter`                    | `object` | This is the containing object for filters used in fetching language files.                                                                        |
| `filter.minimum_percentage` | `boolean` | The percentage of strings that must be translated in order to download the file. See [`.puprc-defaults`](/.puprc-defaults) for the default value. |
| `formats` | `array` | The array of file formats to download. Defaults to `['mo', 'po']`.                                                                                |
| `path` | `string` | The path to download the language files to. Defaults to `lang`.                                                                                   |
| `slug` | `string` | The slug used in GlotPress to identify the project.                                                                                               |
| `textdomain` | `string` | The textdomain used in the project.                                                                                                               |
| `url` | `string` | The URL to the GlotPress API endpoint.                                                                                                            |
